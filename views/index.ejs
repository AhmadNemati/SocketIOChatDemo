<!-- WHOLE APP FRAME -->
<!DOCTYPE html>
<html>
<head>
    <% include ../views/templates/head %>
    <link rel="stylesheet" href="/stylesheets/chat_style.css">
</head>

<body>
    <section class="container">

      <h1>Welcome to <%= title %> <a href="https://github.com/ageapps/SocketIOChatDemo" target="_blank"><img src="/images/github.png" alt="GitHub account"  width="35px"/></a></h1>


      <div class="chat_container">
        <div class="panel panel-default panel-dark container">
          <div class="panel-body pannel-body-left col-xs-6 ">
            <strong id="user_name"></strong>
          </div>
          <div class="panel-body pannel-body-right col-xs-6 ">
            <small id="user_typing"></small>
            People connected
            <span class="badge"id="users_connected"><%= number_connected %></span>
          </div>
        </div>
        <div id="messages_container">
          <ul id="messages"></ul>
        </div>
      </div>





    <div class="container" id="login_container">
      <div class="row">
        <div class="Absolute-Center is-Responsive">
          <div class="col-sm-12 col-md-10 col-md-offset-1 text-center">
            <h3>Enter your Name</h3>
            <form action="" id="login_form">
              <div class="form-group input-group">
                <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                <input class="form-control" type="text" id="user" placeholder="..."/>
              </div>
              <div class="form-group">
                <button type="submit button" class="btn btn-def btn-block">Login</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>


    </section>

    <form class="chat_container form-inline" id="chat_input" action="">
        <input id="m" autocomplete="off" placeholder="Write your mensaje..."/>
        <button type="submit button" class="btn btn-primary btn-md">Send</button>
    </form>


    <% include ../views/templates/scripts %>

    <script src="/socket/socket.io.js"></script>
    <script type="text/javascript">

      $(function() {
        $('#login_container').show();
        $('.chat_container').hide();
        });
</script>

  <script type="text/javascript">
  var myName = "";
    var socket = io();
    $('#login_form').submit(function() {
      if ($('#user').val() && ($('#user').val() != "")) {
        socket.emit('new user', $('#user').val());
        myName = $('#user').val();
        $('#user_name').text(myName);
        $('#user').val('');
        $('#login_container').hide();
        $('.chat_container').show();
        }
      return false;
    });

    $('#chat_input').submit(function() {
      if ($('#m').val() && $('#m').val() != "") {
        socket.emit('chat message', $('#m').val());
        appendMessage(true,$('#m').val());
        $('#m').val('');
      }
      return false;
    });

    socket.on('connection on off', function(number) {
      $('#users_connected').text(number);
    });

    socket.on('chat message', function(msg, name) {
        appendMessage(false,msg,name);
    });

    socket.on('typing', function(isTyping, name) {
      var text = ""
      if (isTyping) {
        text = name + " is typing..."
      }
      $('#user_typing').text(text);
    });

    function appendMessage(mine , msg, name) {
      var panelType = "";
      var person = "me";
      if (!mine) {
        panelType = "_dark";
        person = name;
      }
      $('#messages').append('<li class=\"'+ panelType+'\"> <div class=\"direct-chat-text' + panelType +'\"><h5 class=\"chat_heading\">'+ person +'</h5>'+
      '<p>' + msg + '</p></div></li>')
        // $('#messages').append('<li>'+ msg +'</li>')
        // $('#messages').append('<li> <div class=\"panel panel-primary ' + panelType +'\"> '+
        // '<div class=\"panel-heading\">'+ name +
        // '</div><div class=\"panel-body\">' + msg + '</div></div> </li>');

    }

    //setup before functions
var typingTimer;                //timer identifier
var doneTypingInterval = 3000;  //time in ms, 5 second for example
var $input = $('#m');

//on keyup, start the countdown
$input.on('keyup', function () {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(doneTyping, doneTypingInterval);
});

//on keydown, clear the countdown
$input.on('keydown', function () {
  socket.emit("typing", true, myName);
  clearTimeout(typingTimer);
});

//user is "finished typing," do something
function doneTyping () {
  socket.emit("typing", false, myName);
}



    </script>

</body>
</html>
